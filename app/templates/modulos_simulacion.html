{% extends "base.html" %}

{% block title %}Simulaci√≥n de {{ modulo.nombre }}{% endblock %}

{% block content %}
<h1 class="text-center">Simulaci√≥n del M√≥dulo: {{ modulo.nombre }}</h1>
<h2 class="text-center">Planta: {{ modulo.planta.especie }}</h2>

<div class="wrap">
    <div class="state-container text-center">
        <div class="box {{ estado_color }}" id="estado-planta">
            <span class="emoji">
                {% if estado_color == 'green' %} üòä
                {% elif estado_color == 'yellow' %} üòê
                {% elif estado_color == 'orange' %} üòü
                {% else %} üò≠
                {% endif %}
            </span>
            <span class="texto">
                {% if estado_color == 'green' %} ¬°Todo bien!
                {% elif estado_color == 'yellow' %} En cuidado
                {% elif estado_color == 'orange' %} Preocupado
                {% else %} Necesito ayuda
                {% endif %}
            </span>
        </div>
    </div>
</div>

<div class="container mt-4">
    <table class="table table-bordered text-center">
        <thead class="table-dark">
            <tr>
                <th>Rango Ideal</th>
                <th>Valor Actual</th>
                <th>Condici√≥n</th>
                <th>Estado</th>
            </tr>
        </thead>
        <tbody id="tabla-simulacion">
            {% for nombre, valor in valores_simulados.items() %}
            <tr>
                <td>
                    <span class="rango">{{ rangos_dict[nombre]["min"] | round(1) }} - {{ rangos_dict[nombre]["max"] | round(1) }}</span>
                    {{ rangos_dict[nombre].get("unidad", "Sin unidad") }} ({{ nombre }})
                </td>
                <td>
                    <strong class="valor">{{ valor | round(1) }}</strong>
                    {{ rangos_dict[nombre].get("unidad", "Sin unidad") }}
                </td>
                <td class="estado" id="estado-{{ nombre }}" data-min="{{ rangos_dict[nombre]['min'] }}" data-max="{{ rangos_dict[nombre]['max'] }}">
                    {% set dif_min = rangos_dict[nombre]["min"] - valor %}
                    {% set dif_max = valor - rangos_dict[nombre]["max"] %}
                    {% if valor >= rangos_dict[nombre]["min"] and valor <= rangos_dict[nombre]["max"] %}
                        üü¢ Dentro del rango ideal
                    {% elif dif_max > 0 and dif_max <= 4 %}
                        üü° Exceso de {{ nombre }} +{{ dif_max | round(1) }}
                    {% elif dif_max > 4 and dif_max <= 9 %}
                        üü† Exceso de {{ nombre }} +{{ dif_max | round(1) }}
                    {% elif dif_max >= 10 %}
                        üî¥ Exceso de {{ nombre }} +{{ dif_max | round(1) }}
                    {% elif dif_min > 0 and dif_min <= 4 %}
                        üü° Falta de {{ nombre }} -{{ dif_min | round(1) }}
                    {% elif dif_min > 4 and dif_min <= 9 %}
                        üü† Falta de {{ nombre }} -{{ dif_min | round(1) }}
                    {% elif dif_min >= 10 %}
                        üî¥ Falta de {{ nombre }} -{{ dif_min | round(1) }}
                    {% endif %}
                </td>
                <td class="alerta" id="alerta-{{ nombre }}">
                    {% if valor < rangos_dict[nombre]["min"] or valor > rangos_dict[nombre]["max"] %}
                        ‚ö†Ô∏è Alerta
                    {% elif abs(valor - rangos_dict[nombre]["min"]) <= 2 or abs(valor - rangos_dict[nombre]["max"]) <= 2 %}
                        ‚ö†Ô∏è Precauci√≥n
                    {% else %}
                        ‚úÖ Ok
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
        </tbody>        
    </table>
</div>

<div class="d-flex justify-content-center mt-4">
    <button id="btn-simular" class="btn btn-primary" data-modulo-id="{{ modulo.id }}">Generar Nuevos Valores</button>
    <a href="{{ url_for('main.index') }}" class="btn btn-secondary ms-2">Volver al Inicio</a>
</div>

{% block scripts %}
    <script src="{{ url_for('static', filename='js/simulacion.js') }}"></script>
<script>
    document.addEventListener("DOMContentLoaded", function() {
        document.getElementById("btn-simular").setAttribute("data-modulo-id", "{{ modulo.id }}");
    });
</script>
{% endblock %}

{% endblock %}
